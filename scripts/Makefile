# TC Agro Analytics - Makefile
# Simplifies Docker Compose commands

.PHONY: help up down logs ps restart clean rebuild db-migrate db-seed

# Default target
.DEFAULT_GOAL := help

# Colors for output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Show this help message
	@echo "$(BLUE)TC Agro Analytics - Docker Infrastructure$(NC)"
	@echo ""
	@echo "$(GREEN)Available commands:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2}'

up: ## Start all services
	@echo "$(GREEN)üöÄ Starting services...$(NC)"
	@docker-compose up -d
	@echo "$(GREEN)‚úÖ Services started!$(NC)"
	@make ps

up-minimal: ## Start only essential services (PostgreSQL & RabbitMQ)
	@echo "$(GREEN)üöÄ Starting minimal services...$(NC)"
	@docker-compose -f docker-compose.minimal.yml up -d
	@echo "$(GREEN)‚úÖ Minimal services started!$(NC)"

down: ## Stop all services
	@echo "$(YELLOW)üõë Stopping services...$(NC)"
	@docker-compose down
	@echo "$(GREEN)‚úÖ Services stopped!$(NC)"

down-volumes: ## Stop services and remove volumes (‚ö†Ô∏è  data will be lost)
	@echo "$(RED)‚ö†Ô∏è  WARNING: This will delete all data!$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		docker-compose down -v; \
		echo "$(GREEN)‚úÖ Services stopped and volumes removed!$(NC)"; \
	else \
		echo ""; \
		echo "$(YELLOW)Cancelled.$(NC)"; \
	fi

logs: ## Show logs from all services
	@docker-compose logs -f

logs-postgres: ## Show PostgreSQL logs
	@docker-compose logs -f tc-agro-postgres

logs-rabbitmq: ## Show RabbitMQ logs
	@docker-compose logs -f tc-agro-rabbitmq

logs-redis: ## Show Redis logs
	@docker-compose logs -f tc-agro-redis

ps: ## Show running services
	@echo "$(BLUE)üìä Service Status:$(NC)"
	@docker-compose ps
	@echo ""
	@echo "$(BLUE)üîó Service URLs:$(NC)"
	@echo "  PostgreSQL:         localhost:5432"
	@echo "  RabbitMQ AMQP:      localhost:5672"
	@echo "  RabbitMQ Management: http://localhost:15672"
	@echo "  Redis:              localhost:6379"
	@echo "  Grafana:            http://localhost:3000"
	@echo "  pgAdmin:            http://localhost:5050"

restart: ## Restart all services
	@echo "$(YELLOW)üîÑ Restarting services...$(NC)"
	@docker-compose restart
	@echo "$(GREEN)‚úÖ Services restarted!$(NC)"

clean: ## Remove stopped containers and dangling images
	@echo "$(YELLOW)üßπ Cleaning up...$(NC)"
	@docker-compose down --remove-orphans
	@docker system prune -f
	@echo "$(GREEN)‚úÖ Cleanup complete!$(NC)"

rebuild: ## Rebuild and restart all services
	@echo "$(YELLOW)üî® Rebuilding services...$(NC)"
	@docker-compose down
	@docker-compose up -d --build
	@echo "$(GREEN)‚úÖ Services rebuilt!$(NC)"

pull: ## Pull latest images
	@echo "$(BLUE)üì• Pulling latest images...$(NC)"
	@docker-compose pull
	@echo "$(GREEN)‚úÖ Images updated!$(NC)"

db-shell: ## Open PostgreSQL shell
	@echo "$(BLUE)üêò Connecting to PostgreSQL...$(NC)"
	@docker exec -it tc-agro-postgres psql -U postgres -d tc_agro_analytics

db-backup: ## Backup PostgreSQL database
	@echo "$(BLUE)üíæ Backing up database...$(NC)"
	@docker exec tc-agro-postgres pg_dump -U postgres tc_agro_analytics > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)‚úÖ Backup created!$(NC)"

db-restore: ## Restore PostgreSQL database from backup (Usage: make db-restore FILE=backup.sql)
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)‚ùå Error: Please specify FILE=<backup.sql>$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)üîÑ Restoring database from $(FILE)...$(NC)"
	@docker exec -i tc-agro-postgres psql -U postgres tc_agro_analytics < $(FILE)
	@echo "$(GREEN)‚úÖ Database restored!$(NC)"

rabbitmq-status: ## Show RabbitMQ status
	@echo "$(BLUE)üê∞ RabbitMQ Status:$(NC)"
	@docker exec tc-agro-rabbitmq rabbitmqctl status

rabbitmq-queues: ## List RabbitMQ queues
	@echo "$(BLUE)üì¨ RabbitMQ Queues:$(NC)"
	@docker exec tc-agro-rabbitmq rabbitmqctl list_queues

redis-cli: ## Open Redis CLI
	@echo "$(BLUE)üî¥ Connecting to Redis...$(NC)"
	@docker exec -it tc-agro-redis redis-cli

health: ## Check health of all services
	@echo "$(BLUE)üè• Health Check:$(NC)"
	@docker ps --format "table {{.Names}}\t{{.Status}}"

stats: ## Show resource usage of containers
	@echo "$(BLUE)üìà Resource Usage:$(NC)"
	@docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
